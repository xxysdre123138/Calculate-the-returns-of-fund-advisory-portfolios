import pandas as pd
import tkinter as tk
from tkinter import filedialog
import os


def merge_combination_data():
    # === é€‰æ‹©ä¸‰å¼ è¡¨æ ¼ ===
    root = tk.Tk()
    root.withdraw()

    print("ğŸ“„ è¯·é€‰æ‹©ç¬¬ä¸€å¼ è¡¨æ ¼ï¼ˆæŠ•èµ„æ”¶ç›Šæ•°æ®ï¼‰")
    file1 = filedialog.askopenfilename(title="é€‰æ‹©è¡¨æ ¼1", filetypes=[("Excel files", "*.xlsx")])
    print("ğŸ“„ è¯·é€‰æ‹©ç¬¬äºŒå¼ è¡¨æ ¼ï¼ˆèµ„é‡‘ä¸å®¢æˆ·æ•°å˜åŒ–ï¼‰")
    file2 = filedialog.askopenfilename(title="é€‰æ‹©è¡¨æ ¼2", filetypes=[("Excel files", "*.xlsx")])
    print("ğŸ“„ è¯·é€‰æ‹©ç¬¬ä¸‰å¼ è¡¨æ ¼ï¼ˆæ€»èµ„äº§ä¸å®¢æˆ·æ•°ï¼‰")
    file3 = filedialog.askopenfilename(title="é€‰æ‹©è¡¨æ ¼3", filetypes=[("Excel files", "*.xlsx")])

    if not file1 or not file2 or not file3:
        print("âŒ æœ‰æ–‡ä»¶æœªé€‰æ‹©ï¼Œç¨‹åºç»ˆæ­¢ã€‚")
        return

    # === è¯»å–ä¸‰å¼ è¡¨æ ¼ ===
    df1 = pd.read_excel(file1)
    df2 = pd.read_excel(file2)
    df3 = pd.read_excel(file3)

    # === æ¸…æ´—åˆ—åï¼Œå»é™¤ç©ºæ ¼ ===
    df1.columns = df1.columns.str.strip()
    df2.columns = df2.columns.str.strip()
    df3.columns = df3.columns.str.strip()

    # === åˆå¹¶è¡¨2ï¼šç­¾çº¦ã€è§£çº¦ã€è½¬å…¥è½¬å‡ºé‡‘é¢ ===
    df_merge2 = df2[["ç»„åˆåç§°", "ç­¾çº¦å®¢æˆ·æ•°(æˆ·)", "è§£çº¦å®¢æˆ·æ•°(æˆ·)", "è½¬å…¥èµ„é‡‘(å…ƒ)", "è½¬å‡ºèµ„é‡‘(å…ƒ)"]].copy()
    df_merge2["æ–°å¢é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰"] = df_merge2["è½¬å…¥èµ„é‡‘(å…ƒ)"] / 10000
    df_merge2["å‡å°‘é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰"] = df_merge2["è½¬å‡ºèµ„é‡‘(å…ƒ)"] / 10000
    df_merge2.drop(["è½¬å…¥èµ„é‡‘(å…ƒ)", "è½¬å‡ºèµ„é‡‘(å…ƒ)"], axis=1, inplace=True)

    # === åˆå¹¶è¡¨3ï¼šå®¢æˆ·æ•°ä¸æ€»èµ„äº§ ===
    df_merge3 = df3[["ç»„åˆåç§°", "å®¢æˆ·æ•°", "æ€»èµ„äº§(ä¸‡å…ƒ)"]].copy()

    # === åˆå¹¶æ‰€æœ‰æ•°æ®åˆ°è¡¨æ ¼1 ===
    df_final = df1.copy()

    # æ³¨æ„ mergeï¼šå·¦è¿æ¥ï¼Œä»¥è¡¨æ ¼1ä¸ºä¸»ï¼Œé¿å…å› ç»„åˆé¡ºåºä¸åŒå¯¼è‡´é—æ¼
    df_final = pd.merge(df_final, df_merge2, how="left", on="ç»„åˆåç§°")
    df_final = pd.merge(df_final, df_merge3, how="left", on="ç»„åˆåç§°")

    # === å¤„ç†â€œè´§å¸å¢å¼ºâ€ç»„åˆï¼šä»…ä¿ç•™ç¬¬ä¸€æ¬¡åŒ¹é…ç»“æœ ===
    if (df_final["ç»„åˆåç§°"] == "è´§å¸å¢å¼º").sum() > 1:
        idx = df_final[df_final["ç»„åˆåç§°"] == "è´§å¸å¢å¼º"].index[0]
        dup_idx = df_final[df_final["ç»„åˆåç§°"] == "è´§å¸å¢å¼º"].index[1:]
        df_final.loc[dup_idx, ["ç­¾çº¦å®¢æˆ·æ•°(æˆ·)", "è§£çº¦å®¢æˆ·æ•°(æˆ·)", "æ–°å¢é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰", "å‡å°‘é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰", "å®¢æˆ·æ•°",
                               "æ€»èµ„äº§(ä¸‡å…ƒ)"]] = None

    df_final["æ€»ä»½é¢ï¼ˆä¸‡ä»½ï¼‰"] = df_final["æ€»èµ„äº§(ä¸‡å…ƒ)"] / df_final["ç»„åˆå‡€å€¼"]

    df_final["å‡€å€¼æ—¥æœŸ"] = pd.to_datetime(df_final["å‡€å€¼æ—¥æœŸ"]).dt.strftime("%Y/%m/%d")
    df_final["èµ·å§‹æ—¥æœŸ"] = pd.to_datetime(df_final["èµ·å§‹æ—¥æœŸ"]).dt.strftime("%Y/%m/%d")

    # === ç»„åˆæ’åº ===
    # å›ºå®šé¡ºåºï¼ˆæ³¨æ„ï¼šä¸å«æœ€åä¸€è¡Œâ€œè´§å¸å¢å¼ºâ€ï¼‰
    custom_order = [
        "è‚¡å€ºå¹³è¡¡", "å€ºåˆ¸ç¨³å¥", "è´§å¸å¢å¼º", "è‚¡ç¥¨ç²¾é€‰", "é‡åŒ–ç¿é€‰", "åŒä¸šå­˜å•",
        "å›ºæ”¶å¢å¼º", "å€ºåˆ¸è‡»é€‰", "æŒ‡å¢ä¸¥é€‰", "åè‚¡æ™ºé€‰", "æ¶ˆè´¹ä¸¥é€‰", "çŸ­å€ºä¼˜é€‰",
        "çº¢åˆ©ä¼˜é€‰", "å…ˆè¿›åˆ¶é€ "
    ]

    # æå–æœ€åä¸€è¡Œâ€œè´§å¸å¢å¼ºâ€
    last_row = df_final.iloc[[-1]] if df_final.iloc[-1]["ç»„åˆåç§°"] == "è´§å¸å¢å¼º" else pd.DataFrame()

    # æ’é™¤æœ€åä¸€è¡Œå¹¶æŒ‰æŒ‡å®šé¡ºåºæ’åº
    df_except_last = df_final.iloc[:-1] if not last_row.empty else df_final.copy()
    df_except_last = df_except_last.set_index("ç»„åˆåç§°").loc[custom_order].reset_index()

    # åˆå¹¶æ’åºç»“æœ + åŸæœ«å°¾â€œè´§å¸å¢å¼ºâ€
    df_final = pd.concat([df_except_last, last_row], ignore_index=True)

    # ç»Ÿä¸€æŠŠâ€œç»„åˆåç§°â€æ˜¾ç¤ºä¸ºâ€œâ€¦â€¦ç»„åˆâ€
    df_final["ç»„åˆåç§°"] = (
            df_final["ç»„åˆåç§°"].astype(str).str.strip()
            .str.replace(r"ç»„åˆ$", "", regex=True)  # å…ˆå»æ‰å·²æœ‰çš„â€œç»„åˆâ€åç¼€ï¼ˆé˜²æ­¢é‡å¤ï¼‰
            + "ç»„åˆ"
    )

    # åˆ é™¤ä¸éœ€è¦çš„åˆ—
    df_final.drop(columns=["ç­–ç•¥åç§°", "ç»„åˆä»£ç "], inplace=True)

    # è®¾ç½®å¯¼å‡ºåˆ—é¡ºåº
    columns_order = [
        "ç»„åˆåç§°",  # è‡ªå®šä¹‰åŠ å…¥
        "å‡€å€¼æ—¥æœŸ",
        "ç»„åˆå‡€å€¼",
        "åŸºå‡†å‡€å€¼",
        "ç»„åˆç´¯è®¡æ”¶ç›Š",
        "åŸºå‡†ç´¯è®¡æ”¶ç›Š",
        "è¶…é¢æ”¶ç›Š",
        "ç»„åˆå¹´åŒ–æ”¶ç›Š",
        "åŸºå‡†å¹´åŒ–æ”¶ç›Š",
        "ç­¾çº¦å®¢æˆ·æ•°(æˆ·)",
        "è§£çº¦å®¢æˆ·æ•°(æˆ·)",
        "å®¢æˆ·æ•°",
        "æ–°å¢é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰",
        "å‡å°‘é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰",
        "æ€»èµ„äº§(ä¸‡å…ƒ)",
        "æ€»ä»½é¢ï¼ˆä¸‡ä»½ï¼‰",
        "è¿è¡Œå¤©æ•°",
        "èµ·å§‹æ—¥æœŸ"
    ]

    # é‡æ–°æ’åº
    df_final = df_final[columns_order]

    # 2) ç»Ÿä¸€æ”¹æˆâ€œå›¾1â€é‡Œçš„æ ‡å‡†åˆ—å
    rename_to_standard = {
        "å‡€å€¼æ—¥æœŸ": "æ—¥æœŸ",
        "ç»„åˆç´¯è®¡æ”¶ç›Š": "ç»„åˆç´¯è®¡æ”¶ç›Š*",
        "ç­¾çº¦å®¢æˆ·æ•°(æˆ·)": "ç­¾çº¦å®¢æˆ·æ•°",
        "è§£çº¦å®¢æˆ·æ•°(æˆ·)": "è§£çº¦å®¢æˆ·æ•°",
        "å®¢æˆ·æ•°": "ç´¯è®¡å®¢æˆ·æ•°",
        "æ€»èµ„äº§(ä¸‡å…ƒ)": "æ€»èµ„äº§ï¼ˆä¸‡å…ƒï¼‰",  # å…¨è§’æ‹¬å·
        # â€œæ€»ä»½é¢ï¼ˆä¸‡ä»½ï¼‰â€æœ¬èº«å·²æ˜¯ç›®æ ‡åï¼Œè¿™é‡Œä¸å¿…æ”¹
    }
    df_final.rename(columns=rename_to_standard, inplace=True)

    # 3) å¯é€‰ï¼šå†æŒ‰â€œå›¾1â€æœ€ç»ˆé¡ºåºç¡®ä¿ä¸€æ¬¡ï¼ˆä¸å†™ä¹Ÿè¡Œï¼Œé¡ºåºå·²ä¿æŒï¼‰
    final_cols = [
        "ç»„åˆåç§°", "æ—¥æœŸ", "ç»„åˆå‡€å€¼", "åŸºå‡†å‡€å€¼", "ç»„åˆç´¯è®¡æ”¶ç›Š*",
        "åŸºå‡†ç´¯è®¡æ”¶ç›Š", "è¶…é¢æ”¶ç›Š", "ç»„åˆå¹´åŒ–æ”¶ç›Š", "åŸºå‡†å¹´åŒ–æ”¶ç›Š",
        "ç­¾çº¦å®¢æˆ·æ•°", "è§£çº¦å®¢æˆ·æ•°", "ç´¯è®¡å®¢æˆ·æ•°",
        "æ–°å¢é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰", "å‡å°‘é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰",
        "æ€»èµ„äº§ï¼ˆä¸‡å…ƒï¼‰", "æ€»ä»½é¢ï¼ˆä¸‡ä»½ï¼‰", "è¿è¡Œå¤©æ•°", "èµ·å§‹æ—¥æœŸ",
    ]
    df_final = df_final[final_cols]

    #    # === è¾“å‡ºæ–‡ä»¶ ===
    # output_path = os.path.join(os.getcwd(), "åˆå¹¶ç»“æœ_åŸºé‡‘ç»„åˆæ•°æ®.xlsx")

    # === è¾“å‡ºæ–‡ä»¶ï¼ˆè‡ªåŠ¨å¸¦æ˜¨å¤©æ—¥æœŸï¼Œä¿å­˜åœ¨è„šæœ¬æ‰€åœ¨ç›®å½•ï¼‰ ===
    import datetime

    script_dir = os.path.dirname(os.path.abspath(__file__))  # è„šæœ¬æ‰€åœ¨ç›®å½•
    yesterday_str = (datetime.date.today() - datetime.timedelta(days=1)).strftime("%Y-%m-%d")
    output_path = os.path.join(script_dir, f"åŸºé‡‘æ•°æ®ç»Ÿè®¡ç»“æœ_{yesterday_str}.xlsx")

    df_final.to_excel(output_path, index=False)
    print(f"âœ… åˆå¹¶å®Œæˆï¼Œå·²ä¿å­˜åˆ°ï¼š{output_path}")


# === æ‰§è¡Œä¸»ç¨‹åº ===
if __name__ == "__main__":
    merge_combination_data()
